{{- /*
Render the ScaledObject when:
  * keda.enabled true
  * autoscaling (HPA) disabled
  * at least one trigger defined
  * AND (either the CRD already exists in cluster capabilities OR we are also installing KEDA via dependency this release)

Previously we required the CRD to exist which forced a second helm upgrade on first install. Including the keda.install flag avoids that extra step.
*/ -}}
{{- if and .Values.keda.enabled (not .Values.autoscaling.enabled) .Values.keda.triggers (gt (len .Values.keda.triggers) 0) (or (.Capabilities.APIVersions.Has "keda.sh/v1alpha1") (.Values.keda.install)) }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ include "app.fullname" . }}
  labels:
    app.kubernetes.io/name: {{ include "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    application: {{ include "app.name" . }}
spec:
  scaleTargetRef:
    name: {{ include "app.fullname" . }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  minReplicaCount: {{ .Values.keda.minReplicaCount }}
  maxReplicaCount: {{ .Values.keda.maxReplicaCount }}
  triggers:
    {{- range .Values.keda.triggers }}
    - type: {{ .type }}
      {{- if .metadata }}
      metadata:
        {{- range $k, $v := .metadata }}
        {{ $k }}: {{ $v | quote }}
        {{- end }}
      {{- end }}
      {{- if .authenticationRef }}
      authenticationRef:
        name: {{ .authenticationRef.name }}
      {{- end }}
    {{- end }}
{{- else if and .Values.keda.enabled (not (.Capabilities.APIVersions.Has "keda.sh/v1alpha1")) (not .Values.keda.install) }}
{{- /* Emit a harmless comment so users know why ScaledObject not created */ -}}
# KEDA enabled in values but CRD keda.sh/v1alpha1 not found. Install KEDA:
#   helm repo add kedacore https://kedacore.github.io/charts
#   helm install keda kedacore/keda -n keda --create-namespace
{{- end }}
